name: Deploy LatePoint Telegram Integration

on:
  push:
    branches: [main]
    paths:
      - 'bot/**'
      - 'plugin/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "=========================================="
            echo "üöÄ Starting deployment..."
            echo "=========================================="

            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è backup –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p /opt/backups

            # Backup –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
            echo "üì¶ Creating backup..."
            BACKUP_FILE="/opt/backups/blagovest-bot-backup-$(date +%Y%m%d_%H%M%S).tar.gz"
            tar -czf "$BACKUP_FILE" \
              /opt/blagovest-telegram-bot/*.py \
              /opt/blagovest-telegram-bot/handlers/ \
              /opt/blagovest-telegram-bot/services/ \
              /opt/blagovest-telegram-bot/database/ \
              2>/dev/null || echo "‚ö†Ô∏è  Warning: Some files missing (first deploy?)"

            if [ -f "$BACKUP_FILE" ]; then
              echo "‚úÖ Backup created: $BACKUP_FILE"
            fi

            # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ backup —Ñ–∞–π–ª–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            ls -t /opt/backups/blagovest-bot-backup-*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
            if [ ! -d "/opt/blagovest-telegram-bot" ]; then
              echo "üìÅ Creating bot directory..."
              mkdir -p /opt/blagovest-telegram-bot
            fi

            cd /opt/blagovest-telegram-bot

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ ! -d ".git" ]; then
              echo "üîß Initializing git repository..."
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
            fi

            # –û–±–Ω–æ–≤–∏—Ç—å origin URL –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
            git remote set-url origin https://github.com/${{ github.repository }}.git

            # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å config.py –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ -f "config.py" ]; then
              echo "üíæ Preserving config.py..."
              cp config.py /tmp/config.py.backup
            fi

            # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ -f "bot_data.db" ]; then
              echo "üíæ Preserving bot_data.db..."
              cp bot_data.db /tmp/bot_data.db.backup
            fi

            # Pull latest code
            echo "üì• Pulling latest code from main branch..."
            git fetch origin main
            git reset --hard origin/main

            # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å config.py
            if [ -f "/tmp/config.py.backup" ]; then
              echo "‚ôªÔ∏è  Restoring config.py..."
              cp /tmp/config.py.backup config.py
              rm /tmp/config.py.backup
            else
              echo "‚ö†Ô∏è  Warning: config.py not found. Please create it manually."
            fi

            # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            if [ -f "/tmp/bot_data.db.backup" ]; then
              echo "‚ôªÔ∏è  Restoring bot_data.db..."
              cp /tmp/bot_data.db.backup bot_data.db
              rm /tmp/bot_data.db.backup
            fi

            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p logs

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ requirements.txt
            if git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -q "requirements.txt"; then
              echo "üì¶ Installing Python dependencies..."
              pip3 install -r bot/requirements.txt --quiet || pip3 install -r requirements.txt --quiet
            else
              echo "‚è≠Ô∏è  Skipping pip install (requirements.txt unchanged)"
            fi

            # –î–µ–ø–ª–æ–π WordPress –ø–ª–∞–≥–∏–Ω–∞
            echo "üîå Deploying WordPress plugin..."
            PLUGIN_DEST="/home/blagovest.net/public_html/wp-content/plugins/latepoint-telegram"

            if [ -d "$PLUGIN_DEST" ]; then
              rsync -av --delete \
                --exclude='config.php' \
                --exclude='.DS_Store' \
                plugin/ \
                "$PLUGIN_DEST/"
              echo "‚úÖ WordPress plugin deployed"
            else
              echo "‚ö†Ô∏è  Warning: WordPress plugin directory not found at $PLUGIN_DEST"
            fi

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
            echo "üîÑ Restarting Telegram bot service..."
            systemctl restart telegram-bot-blagovest

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            echo "‚è≥ Waiting for service to start..."
            sleep 3

            if systemctl is-active --quiet telegram-bot-blagovest; then
              echo "‚úÖ Service is running"
              systemctl status telegram-bot-blagovest --no-pager --lines=5
            else
              echo "‚ùå Service failed to start!"
              systemctl status telegram-bot-blagovest --no-pager --lines=20
              exit 1
            fi

            echo "=========================================="
            echo "‚úÖ Deployment completed successfully!"
            echo "=========================================="

      - name: Deployment Success Notification
        if: success()
        run: |
          echo "=========================================="
          echo "‚úÖ LatePoint Telegram Integration deployed!"
          echo "=========================================="
          echo "ü§ñ Bot restarted on VPS"
          echo "üîå WordPress plugin updated"
          echo "üì¶ Backup created"
          echo "üåê Server: ${{ secrets.VPS_HOST }}"
          echo "üìÖ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "=========================================="
          echo "‚ùå Deployment FAILED!"
          echo "=========================================="
          echo "Please check the logs above for details"
          echo "You may need to:"
          echo "  1. Check SSH connection and credentials"
          echo "  2. Verify file paths on the server"
          echo "  3. Check systemd service status"
          echo "  4. Review bot logs on the server"
